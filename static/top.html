<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Top Ranking - Conectahoot</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Montserrat', Inter, system-ui, -apple-system, sans-serif;
      background: #ffffff;
      min-height: 100vh;
      padding: 20px;
      color: #0056a8;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
      animation: fadeInDown 0.8s ease;
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .logo {
      height: 80px;
      width: auto;
      filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.2));
      cursor: pointer;
      transition: all 0.3s ease;
      animation: float 3s ease-in-out infinite;
    }
    
    .logo:hover {
      transform: scale(1.1) rotate(5deg);
      filter: drop-shadow(0 6px 16px rgba(255, 255, 255, 0.4));
    }
    
    .title {
      font-size: 48px;
      font-weight: 900;
      color: #0056a8;
      text-shadow: 0 4px 12px rgba(13, 59, 102, 0.2);
      margin-bottom: 10px;
      letter-spacing: -1px;
      animation: pulse 2s ease-in-out infinite;
    }
    
    .subtitle {
      font-size: 18px;
      color: #0056a8;
      font-weight: 600;
      animation: fadeIn 1.5s ease;
    }
    
    .controls {
      display: flex;
      gap: 16px;
      justify-content: center;
      align-items: center;
      margin-bottom: 40px;
      flex-wrap: wrap;
      animation: fadeIn 1s ease 0.2s backwards;
    }
    
    .btn {
      padding: 16px 32px;
      border-radius: 12px;
      border: 3px solid #0056a8;
      background: rgba(255, 255, 255, 0.95);
      font-size: 18px;
      font-weight: 700;
      color: #0056a8;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(13, 59, 102, 0.15);
    }
    
    .btn:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(13, 59, 102, 0.3);
      background: rgba(0, 86, 168, 0.1);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn.active {
      background: #0056a8;
      color: white;
    }
    
    .podium {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 20px;
      margin-bottom: 40px;
      perspective: 1000px;
      flex-wrap: wrap;
    }
    
    .podium-place {
      background: rgba(15, 58, 97, 0.85);
      backdrop-filter: blur(10px);
      border-radius: 20px 20px 0 0;
      padding: 20px 15px;
      text-align: center;
      min-width: 180px;
      max-width: 280px;
      flex: 1;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
      border: 2px solid rgba(13, 59, 102, 0.3);
    }
    
    .podium-place:hover {
      transform: translateY(-10px) scale(1.05);
      box-shadow: 0 15px 40px rgba(13, 59, 102, 0.3);
    }
    
    .podium-place::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 8px;
    }
    
    .podium-place.first {
      min-height: 380px;
      animation: growUp 1s ease 0.5s backwards, glow 2s ease-in-out infinite;
      order: 2;
    }
    
    .podium-place.first::before {
      background: linear-gradient(90deg, #ffd700, #ffed4e);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
    }
    
    .podium-place.second {
      min-height: 330px;
      animation: growUp 1s ease 0.3s backwards;
      order: 1;
    }
    
    .podium-place.second::before {
      background: linear-gradient(90deg, #c0c0c0, #e8e8e8);
    }
    
    .podium-place.third {
      min-height: 280px;
      animation: growUp 1s ease 0.4s backwards;
      order: 3;
    }
    
    .podium-place.third::before {
      background: linear-gradient(90deg, #cd7f32, #e8a87c);
    }
    
    .medal {
      font-size: 64px;
      margin-bottom: 12px;
      animation: bounce 2s infinite, rotate 4s linear infinite;
      display: inline-block;
    }
    
    .rank-number {
      font-size: 56px;
      font-weight: 900;
      margin-bottom: 12px;
      line-height: 1;
      color: white;
      text-shadow: 2px 2px 8px rgba(255, 255, 255, 0.5);
    }
    
    .participant-name {
      font-size: 18px;
      font-weight: 800;
      color: white;
      margin-bottom: 8px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      line-height: 1.3;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .score {
      font-size: 28px;
      font-weight: 900;
      color: white;
      margin-bottom: 8px;
      animation: countUp 0.5s ease;
    }
    
    .score-label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 1px;
    }
    
    .quiz-info {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.9);
      margin-top: 12px;
      line-height: 1.6;
      font-weight: 600;
    }
    
    .ranking-list {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 60px;
      flex-wrap: wrap;
    }
    
    .ranking-card {
      background: rgba(15, 58, 97, 0.85);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px 15px;
      text-align: center;
      min-width: 180px;
      max-width: 280px;
      flex: 1;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
      border: 2px solid rgba(13, 59, 102, 0.3);
      min-height: 250px;
    }
    
    .ranking-card:hover {
      transform: translateY(-10px) scale(1.05);
      box-shadow: 0 15px 40px rgba(13, 59, 102, 0.3);
    }
    
    .ranking-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 8px;
      background: linear-gradient(90deg, #4a90e2, #7bb3f0);
    }
    
    .ranking-card.fourth {
      animation: growUp 1s ease 1s backwards;
    }
    
    .ranking-card.fifth {
      animation: growUp 1s ease 1.2s backwards;
    }
    
    .roulette-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 40px;
      animation: fadeIn 1s ease;
      width: 100%;
    }
    
    .boxes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      width: 100%;
      padding: 20px;
      max-height: 80vh;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    body {
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    .container {
      overflow-x: hidden;
    }
    
    .name-box {
      background: rgba(15, 58, 97, 0.85);
      backdrop-filter: blur(10px);
      border: 3px solid rgba(13, 59, 102, 0.5);
      border-radius: 16px;
      padding: 24px 18px;
      text-align: center;
      transition: all 0.25s ease;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .name-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(13, 59, 102, 0.3);
    }
    
    .name-box.highlighted {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      border-color: #ffd700;
      transform: scale(1.08);
      box-shadow: 0 0 35px rgba(255, 215, 0, 0.9);
    }
    
    .name-box.winner {
      background: linear-gradient(135deg, #00ff00, #00cc00);
      border-color: #00ff00;
      transform: scale(1.15);
      box-shadow: 0 0 40px rgba(0, 255, 0, 0.9);
      animation: winnerPulse 1s ease infinite;
    }
    
    .name-box.disqualified {
      background: rgba(100, 100, 100, 0.5);
      border-color: rgba(150, 150, 150, 0.5);
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .name-box.disqualified:hover {
      transform: none;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .name-box .box-name {
      font-size: 16px;
      font-weight: 800;
      color: white;
      word-wrap: break-word;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }
    
    .name-box.disqualified .box-name {
      text-decoration: line-through;
      color: rgba(255, 255, 255, 0.6);
    }
    
    @keyframes winnerPulse {
      0%, 100% { 
        transform: scale(1.15);
        box-shadow: 0 0 40px rgba(0, 255, 0, 0.9);
      }
      50% { 
        transform: scale(1.2);
        box-shadow: 0 0 60px rgba(0, 255, 0, 1);
      }
    }
    
    .roulette-button {
      padding: 20px 50px;
      font-size: 24px;
      font-weight: 900;
      border-radius: 16px;
      border: 4px solid #0056a8;
      background: #0056a8;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(13, 59, 102, 0.3);
      position: sticky;
      bottom: 20px;
      z-index: 10;
    }
    
    .roulette-button:hover:not(:disabled) {
      transform: scale(1.1);
      box-shadow: 0 8px 30px rgba(13, 59, 102, 0.5);
    }
    
    .roulette-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .winner-announcement {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.5s ease;
    }
    
    .winner-card {
      background: linear-gradient(135deg, #0056a8, #003d7a);
      padding: 60px;
      border-radius: 30px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: zoomIn 0.6s ease;
      max-width: 90%;
    }
    
    .winner-card .trophy {
      font-size: 120px;
      margin-bottom: 20px;
      animation: bounce 2s infinite;
    }
    
    .winner-card h2 {
      font-size: 48px;
      color: #ffd700;
      margin-bottom: 20px;
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .winner-card .name {
      font-size: 36px;
      color: white;
      font-weight: 900;
      margin-bottom: 30px;
    }
    
    .winner-card button {
      padding: 16px 40px;
      font-size: 20px;
      font-weight: 700;
      border-radius: 12px;
      border: 3px solid white;
      background: white;
      color: #0056a8;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .winner-card button:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 20px rgba(255, 255, 255, 0.5);
    }
    
    .empty-state, .loading {
      text-align: center;
      padding: 80px 20px;
      color: #0056a8;
      font-size: 20px;
      font-weight: 700;
      animation: fadeIn 1s ease;
    }
    
    .empty-state .icon {
      font-size: 80px;
      margin-bottom: 20px;
      opacity: 0.8;
      animation: bounce 2s infinite;
    }
    
    .loading-spinner {
      border: 6px solid rgba(13, 59, 102, 0.2);
      border-top: 6px solid #0056a8;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    .hidden {
      display: none !important;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes growUp {
      from {
        opacity: 0;
        transform: scaleY(0);
        transform-origin: bottom;
      }
      to {
        opacity: 1;
        transform: scaleY(1);
      }
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes glow {
      0%, 100% {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }
      50% {
        box-shadow: 0 10px 40px rgba(255, 215, 0, 0.4);
      }
    }
    
    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes countUp {
      from { opacity: 0; transform: scale(0.5); }
      to { opacity: 1; transform: scale(1); }
    }
    
    @keyframes zoomIn {
      from {
        opacity: 0;
        transform: scale(0.5);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    @media (max-width: 768px) {
      .title {
        font-size: 32px;
      }
      
      .podium {
        flex-direction: column;
        align-items: stretch;
        gap: 20px;
      }
      
      .podium-place {
        width: 100%;
        max-width: 100%;
        min-width: unset;
        min-height: auto !important;
        order: 0 !important;
      }
      
      .boxes-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
      
      .winner-card {
        padding: 40px;
      }
      
      .winner-card h2 {
        font-size: 32px;
      }
      
      .winner-card .name {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo-section">
        <img src="logoHootsinfondo.png" alt="Logo" class="logo" id="logoImg" />
      </div>
      <h1 class="title"></h1>
      <p class="subtitle">Sorteo y Ganadores</p>
    </div>

    <div class="controls">
      <button id="btnTop5" class="btn">Ver Top 5 Ganadores</button>
      <button id="btnRoulette" class="btn">Ruleta de Participantes</button>
    </div>

    <div id="loadingState" class="loading">
      <div class="loading-spinner"></div>
      <div>Cargando datos...</div>
    </div>

    <div id="rankingSection" class="hidden">
      <div id="podiumContainer" class="podium"></div>
      <div id="rankingList" class="ranking-list hidden"></div>
    </div>

    <div id="rouletteSection" class="hidden">
      <div class="roulette-container">
        <div id="boxesContainer" class="boxes-grid"></div>
        <button id="spinBtn" class="roulette-button">SORTEAR GANADOR</button>
      </div>
    </div>

    <div id="winnerAnnouncement" class="winner-announcement hidden">
      <div class="winner-card">
        <div class="trophy">üéâ</div>
        <h2>¬°GANADOR!</h2>
        <div class="name" id="winnerName"></div>
        <button onclick="closeWinner()">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgzpCt7BtRqMu4mocyDA_2sOPwW5yFAU13tb3C02bRIxGepPwKiE2rHW0aTLNLtMJXCId2odRuiIM0457ev_eflqh6AdFr0XM6CN8vDWW_p6-AgqeaXknx0h8R1ck8NSRFEZuBkM0DZBVJ_m_AtRzEehyfLqvyJ9g3D5LXgtf_AhEc34cOu_Cv2TR8ehuFE86gsTx7SbtZpRDW9PnLPinnRHPubNkqE9wWBAcoxL3Ivs2nv3058SF5DZ3RBrc3pWzZJDNiElwwBuxXbf5pRvQzo10BBWOZkBxAAhAPi&lib=Mh3HkE09XIBNleuIlIff4oQCZjjkWjcYT';

    let allData = [];
    let top5Data = [];
    let rouletteParticipants = [];
    let top5Names = new Set();
    let winnersSet = new Set();
    let isSpinning = false;

    const btnTop5 = document.getElementById('btnTop5');
    const btnRoulette = document.getElementById('btnRoulette');
    const loadingState = document.getElementById('loadingState');
    const rankingSection = document.getElementById('rankingSection');
    const rouletteSection = document.getElementById('rouletteSection');
    const spinBtn = document.getElementById('spinBtn');

    async function loadData() {
      try {
        const response = await fetch(API_URL);
        const result = await response.json();
        allData = result.data || [];
        
        console.log('Datos cargados:', allData.length);
        processData();
        loadingState.classList.add('hidden');
        
      } catch (error) {
        console.error('Error:', error);
        loadingState.innerHTML = '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><div>Error al cargar los datos</div></div>';
      }
    }

    function processData() {
      const nameMap = {};
      
      allData.forEach(row => {
        const name = String(row['Real Name'] || '').trim();
        const rank = parseInt(row['Rank']) || 0;
        const quiz = row['Quiz'] || '';
        
        if (name) {
          if (!nameMap[name]) {
            nameMap[name] = {
              name: name,
              count: 0,
              ranks: [],
              quizzes: [],
              minRank: Infinity,
              avgRank: 0
            };
          }
          nameMap[name].count++;
          nameMap[name].ranks.push(rank);
          if (!nameMap[name].quizzes.includes(quiz)) {
            nameMap[name].quizzes.push(quiz);
          }
          if (rank < nameMap[name].minRank) {
            nameMap[name].minRank = rank;
          }
        }
      });

      Object.values(nameMap).forEach(participant => {
        const sum = participant.ranks.reduce((a, b) => a + b, 0);
        participant.avgRank = sum / participant.ranks.length;
      });

      const sorted = Object.values(nameMap).sort((a, b) => {
        if (b.count !== a.count) return b.count - a.count;
        return a.avgRank - b.avgRank;
      });
      
      top5Data = sorted.slice(0, 5);
      top5Names = new Set(top5Data.map(p => p.name));

      rouletteParticipants = [];
      allData.forEach(row => {
        const name = String(row['Real Name'] || '').trim();
        if (name && !top5Names.has(name)) {
          rouletteParticipants.push(name);
        }
      });
      
      for (let i = rouletteParticipants.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [rouletteParticipants[i], rouletteParticipants[j]] = [rouletteParticipants[j], rouletteParticipants[i]];
      }
    }

    function showTop5() {
      loadingState.classList.add('hidden');
      rouletteSection.classList.add('hidden');
      rankingSection.classList.remove('hidden');

      const podiumContainer = document.getElementById('podiumContainer');
      const rankingList = document.getElementById('rankingList');
      podiumContainer.innerHTML = '';
      rankingList.innerHTML = '';
      
      if (top5Data.length === 0) {
        rankingSection.innerHTML = '<div class="empty-state"><div class="icon">üìä</div><div>No se encontraron datos</div></div>';
        return;
      }

      if (top5Data[1]) podiumContainer.appendChild(createPodiumPlace(top5Data[1], 2));
      if (top5Data[0]) podiumContainer.appendChild(createPodiumPlace(top5Data[0], 1));
      if (top5Data[2]) podiumContainer.appendChild(createPodiumPlace(top5Data[2], 3));

      if (top5Data[3]) {
        rankingList.appendChild(createRankingCard(top5Data[3], 4));
        rankingList.classList.remove('hidden');
      }
      if (top5Data[4]) {
        rankingList.appendChild(createRankingCard(top5Data[4], 5));
        rankingList.classList.remove('hidden');
      }
    }

    function createPodiumPlace(participant, rank) {
      const div = document.createElement('div');
      div.className = `podium-place ${rank === 1 ? 'first' : rank === 2 ? 'second' : 'third'}`;
      
      const medals = ['ü•á', 'ü•à', 'ü•â'];
      const quizRankList = participant.quizzes.map(quiz => {
        const ranksForQuiz = [];
        allData.forEach(row => {
          if (String(row['Real Name'] || '').trim() === participant.name && (row['Quiz'] || '') === quiz) {
            ranksForQuiz.push(parseInt(row['Rank']) || 0);
          }
        });
        return `${escapeHtml(quiz)} (Ranks: ${ranksForQuiz.join(', ')})`;
      }).join('<br>');
      
      div.innerHTML = `
        <div class="medal">${medals[rank - 1]}</div>
        <div class="rank-number">#${rank}</div>
        <div class="participant-name">${escapeHtml(participant.name)}</div>
        <div class="score">${participant.count}</div>
        <div class="score-label">Insignias</div>
        <div class="quiz-info">${quizRankList}<br>Promedio: ${participant.avgRank.toFixed(1)}</div>
      `;
      return div;
    }

    function createRankingCard(participant, rank) {
      const div = document.createElement('div');
      div.className = `ranking-card ${rank === 4 ? 'fourth' : 'fifth'}`;
      
      const quizRankList = participant.quizzes.map(quiz => {
        const ranksForQuiz = [];
        allData.forEach(row => {
          if (String(row['Real Name'] || '').trim() === participant.name && (row['Quiz'] || '') === quiz) {
            ranksForQuiz.push(parseInt(row['Rank']) || 0);
          }
        });
        return `${escapeHtml(quiz)} (Ranks: ${ranksForQuiz.join(', ')})`;
      }).join('<br>');
      
      div.innerHTML = `
        <div class="rank-number">#${rank}</div>
        <div class="participant-name">${escapeHtml(participant.name)}</div>
        <div class="score">${participant.count}</div>
        <div class="score-label">Insignias</div>
        <div class="quiz-info">${quizRankList}<br>Promedio: ${participant.avgRank.toFixed(1)}</div>
      `;
      return div;
    }

    function showRoulette() {
      loadingState.classList.add('hidden');
      rankingSection.classList.add('hidden');
      rouletteSection.classList.remove('hidden');
      createRoulette();
    }

    function createRoulette() {
      const boxesContainer = document.getElementById('boxesContainer');
      boxesContainer.innerHTML = '';
      
      if (rouletteParticipants.length === 0) {
        boxesContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #0056a8; font-size: 24px;">No hay participantes disponibles</div>';
        spinBtn.disabled = true;
        return;
      }

      spinBtn.disabled = false;
      
      rouletteParticipants.forEach((name, index) => {
        const box = document.createElement('div');
        box.className = 'name-box';
        if (winnersSet.has(name)) {
          box.classList.add('disqualified');
        }
        box.setAttribute('data-index', index);
        box.setAttribute('data-name', name);
        box.innerHTML = `<div class="box-name">${escapeHtml(name)}</div>`;
        boxesContainer.appendChild(box);
      });
    }

    function spinRoulette() {
      if (isSpinning || rouletteParticipants.length === 0) return;

      const availableParticipants = rouletteParticipants.filter(name => !winnersSet.has(name));
      if (availableParticipants.length === 0) {
        alert('¬°Todos los participantes ya han ganado!');
        return;
      }

      isSpinning = true;
      spinBtn.disabled = true;

      const boxes = document.querySelectorAll('.name-box');
      boxes.forEach(box => {
        if (!box.classList.contains('disqualified')) {
          box.classList.remove('highlighted', 'winner');
        }
      });

      let winnerIndex;
      let winnerName;
      do {
        winnerIndex = Math.floor(Math.random() * rouletteParticipants.length);
        winnerName = rouletteParticipants[winnerIndex];
      } while (winnersSet.has(winnerName));
      
      let highlightCount = 0;
      const maxHighlights = 25 + Math.floor(Math.random() * 10);
      const constantSpeed = 500;
      
      function highlightRandom() {
        boxes.forEach(box => {
          if (!box.classList.contains('disqualified')) {
            box.classList.remove('highlighted');
          }
        });
        
        let randomIndex;
        if (highlightCount < maxHighlights) {
          do {
            randomIndex = Math.floor(Math.random() * boxes.length);
          } while (boxes[randomIndex].classList.contains('disqualified'));
        } else {
          randomIndex = winnerIndex;
        }
        
        boxes[randomIndex].classList.add('highlighted');
        boxes[randomIndex].scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center'
        });
        
        highlightCount++;
        
        if (highlightCount <= maxHighlights) {
          setTimeout(highlightRandom, constantSpeed);
        } else {
          boxes.forEach(box => {
            if (!box.classList.contains('disqualified')) {
              box.classList.remove('highlighted');
            }
          });
          boxes[winnerIndex].classList.add('winner');
          boxes[winnerIndex].scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center'
          });
          
          winnersSet.add(winnerName);
          
          setTimeout(() => {
            showWinner(winnerName);
            isSpinning = false;
          }, 2000);
        }
      }
      
      highlightRandom();
    }

    function showWinner(name) {
      document.getElementById('winnerName').textContent = name;
      document.getElementById('winnerAnnouncement').classList.remove('hidden');
    }

    function closeWinner() {
      document.getElementById('winnerAnnouncement').classList.add('hidden');
      
      const boxes = document.querySelectorAll('.name-box');
      boxes.forEach(box => {
        const boxName = box.getAttribute('data-name');
        box.classList.remove('highlighted', 'winner');
        if (winnersSet.has(boxName)) {
          box.classList.add('disqualified');
        }
      });
      
      spinBtn.disabled = false;
    }

    function escapeHtml(text) {
      if (!text) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.log('No se pudo entrar en pantalla completa:', err);
        });
      } else {
        document.exitFullscreen();
      }
    }

    btnTop5.addEventListener('click', () => {
      btnTop5.classList.add('active');
      btnRoulette.classList.remove('active');
      showTop5();
    });

    btnRoulette.addEventListener('click', () => {
      btnRoulette.classList.add('active');
      btnTop5.classList.remove('active');
      showRoulette();
    });

    spinBtn.addEventListener('click', spinRoulette);
    document.getElementById('logoImg').addEventListener('click', toggleFullscreen);

    loadData();
  </script>
</body>
</html>