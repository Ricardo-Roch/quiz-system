<!--Version estable-->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel ‚Äî Sistema de Quiz</title>
  <style>
    :root{
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --accent-blue: #3b82f6;
      --accent-red: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
      --border: #e2e8f0;
      --shadow: rgba(15, 23, 42, 0.08);
      --primary-red: #ef4444;
      --primary-blue: #3b82f6;
    }
    
    *{box-sizing:border-box}
    
    html,body{
      height:100%;
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      color:var(--text-primary);
      background:linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }
    
    .admin-container{
      display: flex;
      min-height: 100vh;
    }
    
    .sidebar{
      width: 280px;
      background: var(--card-bg);
      border-right: 2px solid var(--border);
      padding: 24px;
      box-shadow: 2px 0 10px var(--shadow);
    }
    
    .main-content{
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }
    
    .logo-section{
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 32px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }
    
    .admin-logo{
      height: 48px;
      width: auto;
    }
    
    .admin-title{
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }
    
    .nav-menu{
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .nav-item{
      margin-bottom: 8px;
    }
    
    .nav-link{
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .nav-link:hover, .nav-link.active{
      background: linear-gradient(135deg, var(--primary-blue), #2563eb);
      color: white;
    }
    
    .nav-icon{
      width: 20px;
      height: 20px;
    }
    
    .logout-btn{
      margin-top: auto;
      padding: 12px 16px;
      background: var(--accent-red);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
      transition: all 0.2s ease;
    }
    
    .logout-btn:hover{
      background: #dc2626;
    }
    
    .page-header{
      margin-bottom: 32px;
    }
    
    .page-title{
      font-size: 32px;
      font-weight: 800;
      margin: 0 0 8px 0;
      background: linear-gradient(135deg, var(--primary-red), var(--primary-blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .page-subtitle{
      color: var(--text-secondary);
      font-size: 16px;
      margin: 0;
    }
    
    .card{
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 15px var(--shadow);
    }
    
    .card-header{
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .card-title{
      font-size: 20px;
      font-weight: 700;
      margin: 0;
    }
    
    .btn{
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn-primary{
      background: linear-gradient(135deg, var(--primary-blue), #2563eb);
      color: white;
    }
    
    .btn-primary:hover{
      background: linear-gradient(135deg, #2563eb, var(--primary-blue));
      transform: translateY(-1px);
    }
    
    .btn-success{
      background: linear-gradient(135deg, var(--success), #059669);
      color: white;
    }
    
    .btn-success:hover{
      background: linear-gradient(135deg, #059669, var(--success));
    }
    
    .btn-danger{
      background: linear-gradient(135deg, var(--accent-red), #dc2626);
      color: white;
    }
    
    .btn-danger:hover{
      background: linear-gradient(135deg, #dc2626, var(--accent-red));
    }
    
    .btn-warning{
      background: linear-gradient(135deg, var(--warning), #d97706);
      color: white;
    }
    
    .btn-warning:hover{
      background: linear-gradient(135deg, #d97706, var(--warning));
    }
    
    .btn-small{
      padding: 8px 16px;
      font-size: 12px;
    }
    
    .table{
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    
    .table th, .table td{
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .table th{
      background: var(--bg-secondary);
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .table tr:hover{
      background: var(--bg-secondary);
    }
    
    .status-badge{
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-active{
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }
    
    .status-inactive{
      background: rgba(239, 68, 68, 0.1);
      color: var(--accent-red);
    }
    
    .form-group{
      margin-bottom: 20px;
    }
    
    .form-label{
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .form-input, .form-textarea, .form-select{
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
      background: var(--bg-secondary);
    }
    
    .form-input:focus, .form-textarea:focus, .form-select:focus{
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }
    
    .form-textarea{
      resize: vertical;
      min-height: 100px;
    }
    
    .modal{
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show{
      display: flex;
    }
    
    .modal-content{
      background: var(--card-bg);
      border-radius: 12px;
      padding: 32px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header{
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }
    
    .modal-title{
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }
    
    .close-btn{
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-muted);
      padding: 4px;
    }
    
    .close-btn:hover{
      color: var(--text-primary);
    }
    
    .loading{
      text-align: center;
      padding: 40px;
      color: var(--primary-blue);
      font-size: 16px;
    }
    
    .error{
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--accent-red);
      padding: 12px;
      border-radius: 8px;
      margin: 16px 0;
    }
    
    .success{
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: var(--success);
      padding: 12px;
      border-radius: 8px;
      margin: 16px 0;
    }
    
    .login-screen{
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 24px;
    }
    
    .login-card{
      background: var(--card-bg);
      padding: 48px;
      border-radius: 16px;
      box-shadow: 0 10px 40px var(--shadow);
      border: 1px solid var(--border);
      width: 100%;
      max-width: 400px;
    }
    
    .login-title{
      font-size: 28px;
      font-weight: 800;
      text-align: center;
      margin: 0 0 32px 0;
      background: linear-gradient(135deg, var(--primary-red), var(--primary-blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .stats-grid{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    
    .stat-card{
      background: linear-gradient(135deg, var(--primary-blue), #2563eb);
      color: white;
      padding: 24px;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-number{
      font-size: 32px;
      font-weight: 800;
      margin: 0 0 8px 0;
    }
    
    .stat-label{
      font-size: 14px;
      opacity: 0.9;
      margin: 0;
    }
    
    .hidden{
      display: none;
    }
    
    .question-item{
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .question-header{
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .question-text{
      font-weight: 600;
      color: var(--text-primary);
      flex: 1;
      margin-right: 16px;
    }
    
    .question-actions{
      display: flex;
      gap: 8px;
    }
    
    .answer-list{
      margin-left: 20px;
    }
    
    .answer-item{
      padding: 8px 0;
      color: var(--text-secondary);
    }
    
    .answer-correct{
      color: var(--success);
      font-weight: 600;
    }

    /* Leaderboard Styles */
    .leaderboard-item{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      margin-bottom: 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      border-left: 4px solid var(--border);
      transition: all 0.2s ease;
    }

    .leaderboard-item:hover{
      background: #f1f5f9;
      transform: translateY(-1px);
    }

    .leaderboard-item.rank-1{
      border-left-color: #ffd700;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
    }

    .leaderboard-item.rank-2{
      border-left-color: #c0c0c0;
      background: linear-gradient(135deg, rgba(192, 192, 192, 0.1), rgba(192, 192, 192, 0.05));
    }

    .leaderboard-item.rank-3{
      border-left-color: #cd7f32;
      background: linear-gradient(135deg, rgba(205, 127, 50, 0.1), rgba(205, 127, 50, 0.05));
    }

    .rank-info{
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .rank-number{
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      min-width: 40px;
      text-align: center;
    }

    .rank-1 .rank-number{
      color: #ffd700;
    }

    .rank-2 .rank-number{
      color: #c0c0c0;
    }

    .rank-3 .rank-number{
      color: #cd7f32;
    }

    .participant-info{
      flex: 1;
    }

    .participant-name{
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 4px 0;
    }

    .participant-uni{
      font-size: 14px;
      color: var(--text-secondary);
      margin: 0;
    }

    .score-info{
      text-align: right;
    }

    .total-score{
      font-size: 20px;
      font-weight: 800;
      color: var(--primary-blue);
      margin: 0 0 4px 0;
    }

    .score-details{
      font-size: 12px;
      color: var(--text-muted);
      margin: 0;
    }

    .empty-leaderboard{
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .empty-leaderboard .icon{
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Tabla de respuestas */
    .responses-table{
      overflow-x: auto;
      max-height: 500px;
      overflow-y: auto;
    }

    .table-striped tbody tr:nth-child(even){
      background: rgba(248, 250, 252, 0.5);
    }

    .table-compact th,
    .table-compact td{
      padding: 8px;
      font-size: 13px;
    }

    .correct-answer{
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      font-weight: 600;
    }

    .incorrect-answer{
      background: rgba(239, 68, 68, 0.1);
      color: var(--accent-red);
      font-weight: 600;
    }

    .response-time{
      font-family: monospace;
      font-size: 12px;
    }

    .empty-table{
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
      font-style: italic;
    }
    
    @media(max-width: 768px){
      .sidebar{
        width: 240px;
      }
      
      .admin-container{
        flex-direction: column;
      }
      
      .sidebar{
        width: 100%;
        padding: 16px;
      }
      
      .main-content{
        padding: 16px;
      }
      
      .stats-grid{
        grid-template-columns: 1fr;
      }
      
      .modal-content{
        margin: 16px;
        width: calc(100% - 32px);
      }
    }

        /* Agregar al CSS existente */
    .open-answer-input {
    width: 100%;
    min-height: 100px;
    padding: 16px;
    border: 2px solid var(--border);
    border-radius: 12px;
    font-size: 16px;
    resize: vertical;
    transition: all 0.3s ease;
    }

    .open-answer-input:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }

    .image-answer {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    }

    .image-answer img {
    max-width: 150px;
    max-height: 150px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    }

    .image-answer:hover img {
    border-color: var(--primary-blue);
    }

    .image-answer.correct img {
    border-color: var(--success);
    }

    .image-answer.wrong img {
    border-color: var(--primary-red);
    }

    .question-image {
    max-width: 100%;
    max-height: 300px;
    object-fit: contain;
    border-radius: 8px;
    margin: 16px 0;
    }

    .submit-open-answer {
    margin-top: 20px;
    padding: 12px 24px;
    background: var(--primary-blue);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    }

    .submit-open-answer:hover {
    background: #2563eb;
    }

    .submit-open-answer:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h1 class="login-title">Admin Panel</h1>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label">Usuario</label>
          <input type="text" id="username" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Contrase√±a</label>
          <input type="password" id="password" class="form-input" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Ingresar</button>
        <div id="loginError" class="error hidden"></div>
      </form>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="admin-container hidden">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo-section">
        <img src="logoHoot.jpeg" alt="Logo" class="admin-logo" />
      </div>
      
      <ul class="nav-menu">
        <li class="nav-item">
          <a class="nav-link active" data-page="dashboard">
            <span class="nav-icon">üìä</span>
            Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-page="quizzes">
            <span class="nav-icon">üìù</span>
            Quizzes
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-page="users">
            <span class="nav-icon">üë•</span>
            Usuarios
          </a>
        </li>
      </ul>
      
      <button class="logout-btn" id="logoutBtn">Cerrar Sesi√≥n</button>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard Page -->
      <div id="dashboardPage" class="page">
        <div class="page-header">
          <h1 class="page-title">Dashboard</h1>
          <p class="page-subtitle">Resumen general del sistema</p>
        </div>

        <div class="stats-grid" id="statsGrid">
          <div class="loading">Cargando estad√≠sticas...</div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üèÜ Top Participantes</h3>
            <select id="quizSelect" class="form-select" style="width: auto;">
              <option value="">Selecciona un quiz</option>
            </select>
          </div>
          <div id="leaderboard">
            <div class="loading">Selecciona un quiz para ver el ranking</div>
          </div>
        </div>

        <div class="card" id="responsesCard" style="display: none;">
          <div class="card-header">
            <h3 class="card-title">üìã Detalle de Respuestas</h3>
            <button class="btn btn-success" id="exportBtn">üìä Exportar CSV</button>
          </div>
          <div id="responsesTable">
            <div class="loading">Cargando respuestas...</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Actividad Reciente</h3>
          </div>
          <div id="recentActivity">
            <div class="loading">Cargando actividad...</div>
          </div>
        </div>
      </div>

      <!-- Quizzes Page -->
      <div id="quizzesPage" class="page hidden">
        <div class="page-header">
          <h1 class="page-title">Gesti√≥n de Quizzes</h1>
          <p class="page-subtitle">Administra todos los quizzes del sistema</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Quizzes</h3>
            <button class="btn btn-primary" id="addQuizBtn">Agregar Quiz</button>
          </div>
          <div id="quizzesList">
            <div class="loading">Cargando quizzes...</div>
          </div>
        </div>
      </div>

      <!-- Users Page -->
      <div id="usersPage" class="page hidden">
        <div class="page-header">
          <h1 class="page-title">Gesti√≥n de Usuarios</h1>
          <p class="page-subtitle">Administra todos los usuarios del sistema</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Usuarios</h3>
            <button class="btn btn-primary" id="addUserBtn">Agregar Usuario</button>
          </div>
          <div id="usersList">
            <div class="loading">Cargando usuarios...</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Quiz Modal -->
  <div id="quizModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="quizModalTitle">Agregar Quiz</h2>
        <button class="close-btn" onclick="closeModal('quizModal')">&times;</button>
      </div>
      <form id="quizForm">
        <input type="hidden" id="quizId">
        <div class="form-group">
          <label class="form-label">T√≠tulo</label>
          <input type="text" id="quizTitle" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">√Årea</label>
          <input type="text" id="quizArea" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Descripci√≥n</label>
          <textarea id="quizDescription" class="form-textarea"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="quizActive"> Activo
          </label>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button type="button" class="btn" onclick="closeModal('quizModal')">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- User Modal -->
  <div id="userModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="userModalTitle">Agregar Usuario</h2>
        <button class="close-btn" onclick="closeModal('userModal')">&times;</button>
      </div>
      <form id="userForm">
        <input type="hidden" id="userId">
        <div class="form-group">
          <label class="form-label">UNI</label>
          <input type="text" id="userUni" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Nombre</label>
          <input type="text" id="userName" class="form-input" required>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button type="button" class="btn" onclick="closeModal('userModal')">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Questions Modal -->
  <div id="questionsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="questionsModalTitle">Preguntas del Quiz</h2>
        <button class="close-btn" onclick="closeModal('questionsModal')">&times;</button>
      </div>
      <div>
        <button class="btn btn-success" id="addQuestionBtn" style="margin-bottom: 20px;">Agregar Pregunta</button>
        <div id="questionsList">
          <div class="loading">Cargando preguntas...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Question Modal -->
  <div id="questionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="questionModalTitle">Agregar Pregunta</h2>
        <button class="close-btn" onclick="closeModal('questionModal')">&times;</button>
      </div>
      <form id="questionForm">
        <input type="hidden" id="questionQuizId">
        <input type="hidden" id="questionId">
        <div class="form-group">
          <label class="form-label">Pregunta</label>
          <textarea id="questionText" class="form-textarea" required></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Orden</label>
          <input type="number" id="questionOrder" class="form-input" min="1" required>
        </div>
        <div class="form-group">
          <label class="form-label">Tiempo l√≠mite (segundos)</label>
          <input type="number" id="questionTimeLimit" class="form-input" min="10" value="30" required>
        </div>
                <!-- En el modal questionModal, agregar campos para tipo y imagen -->
        <div class="form-group">
        <label class="form-label">Tipo de Pregunta</label>
        <select id="questionType" class="form-select">
            <option value="multiple_choice">Opci√≥n M√∫ltiple</option>
            <option value="open_ended">Respuesta Abierta</option>
            <option value="image_choice">Selecci√≥n de Imagen</option>
        </select>
        </div>

        <div class="form-group" id="questionImageGroup" style="display:none;">
        <label class="form-label">Imagen de la Pregunta</label>
        <input type="file" id="questionImageFile" class="form-input" accept="image/*">
        <div id="questionImagePreview" style="margin-top: 10px;"></div>
        </div>
        
        <h4>Respuestas</h4>
        <div id="answersContainer">
          <!-- Answers will be added dynamically -->
        </div>
        <button type="button" class="btn btn-success btn-small" id="addAnswerBtn">Agregar Respuesta</button>
        
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
          <button type="button" class="btn" onclick="closeModal('questionModal')">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
 // API Configuration
const API_BASE_URL = 'https://quiz-system-sfrf.onrender.com';

// Global variables
let currentQuizId = null;
let currentQuestionId = null;
let answerCount = 0;
let currentResponsesData = [];

// DOM Elements
const loginScreen = document.getElementById('loginScreen');
const adminPanel = document.getElementById('adminPanel');
const loginForm = document.getElementById('loginForm');
const loginError = document.getElementById('loginError');

// Navigation
const navLinks = document.querySelectorAll('.nav-link');
const pages = document.querySelectorAll('.page');

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  if (sessionStorage.getItem('adminLoggedIn') === 'true') {
    showAdminPanel();
  }
  setupEventListeners();
});

function setupEventListeners() {
  loginForm.addEventListener('submit', handleLogin);
  document.getElementById('logoutBtn').addEventListener('click', handleLogout);
  
  navLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      navigateToPage(link.dataset.page);
    });
  });
  
  document.getElementById('addQuizBtn').addEventListener('click', () => openQuizModal());
  document.getElementById('addUserBtn').addEventListener('click', () => openUserModal());
  document.getElementById('addQuestionBtn').addEventListener('click', () => openQuestionModal());
  document.getElementById('addAnswerBtn').addEventListener('click', addAnswerField);
  document.getElementById('quizSelect').addEventListener('change', handleQuizSelectChange);
  document.getElementById('exportBtn').addEventListener('click', exportResponses);
  
  document.getElementById('quizForm').addEventListener('submit', handleQuizSubmit);
  document.getElementById('userForm').addEventListener('submit', handleUserSubmit);
  document.getElementById('questionForm').addEventListener('submit', handleQuestionSubmit);
}

async function handleLogin(e) {
  e.preventDefault();
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  
  if (username === 'admin' && password === '1233') {
    sessionStorage.setItem('adminLoggedIn', 'true');
    showAdminPanel();
  } else {
    showLoginError('Credenciales incorrectas');
  }
}

function showLoginError(message) {
  loginError.textContent = message;
  loginError.classList.remove('hidden');
}

function handleLogout() {
  sessionStorage.removeItem('adminLoggedIn');
  loginScreen.classList.remove('hidden');
  adminPanel.classList.add('hidden');
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
  loginError.classList.add('hidden');
}

function showAdminPanel() {
  loginScreen.classList.add('hidden');
  adminPanel.classList.remove('hidden');
  navigateToPage('dashboard');
}

function navigateToPage(pageName) {
  navLinks.forEach(link => {
    link.classList.toggle('active', link.dataset.page === pageName);
  });
  
  pages.forEach(page => {
    page.classList.toggle('hidden', page.id !== `${pageName}Page`);
  });
  
  switch(pageName) {
    case 'dashboard': loadDashboard(); break;
    case 'quizzes': loadQuizzes(); break;
    case 'users': loadUsers(); break;
  }
}

async function loadDashboard() {
  try {
    // Cargar estad√≠sticas b√°sicas
    const response = await fetch(`${API_BASE_URL}/api/quizzes/`);
    const quizzes = await response.json();
    const activeQuizzes = quizzes.filter(q => q.is_active);
    
    // Cargar usuarios
    const usersResponse = await fetch(`${API_BASE_URL}/api/users/`);
    const users = await usersResponse.json();
    
    const statsHtml = `
      <div class="stat-card">
        <div class="stat-number">${quizzes.length}</div>
        <div class="stat-label">Total Quizzes</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, var(--success), #059669);">
        <div class="stat-number">${activeQuizzes.length}</div>
        <div class="stat-label">Quizzes Activos</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, var(--warning), #d97706);">
        <div class="stat-number">${quizzes.length - activeQuizzes.length}</div>
        <div class="stat-label">Quizzes Inactivos</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, var(--primary-red), #dc2626);">
        <div class="stat-number">${users.length}</div>
        <div class="stat-label">Total Usuarios</div>
      </div>
    `;
    
    document.getElementById('statsGrid').innerHTML = statsHtml;
    
    // Populate quiz selector
    const quizSelect = document.getElementById('quizSelect');
    const quizOptions = quizzes.map(quiz => 
      `<option value="${quiz.id}">${quiz.title} - ${quiz.area}</option>`
    ).join('');
    quizSelect.innerHTML = '<option value="">Selecciona un quiz</option>' + quizOptions;
    
    // Recent activity
    const recentHtml = quizzes.slice(0, 5).map(quiz => `
      <div style="padding: 12px 0; border-bottom: 1px solid var(--border);">
        <strong>${quiz.title}</strong> - ${quiz.area}
        <div style="font-size: 12px; color: var(--text-muted);">
          ${new Date(quiz.created_at).toLocaleDateString()}
        </div>
      </div>
    `).join('');
    
    document.getElementById('recentActivity').innerHTML = recentHtml || '<p>No hay actividad reciente</p>';
    
  } catch (error) {
    console.error('Error loading dashboard:', error);
    document.getElementById('statsGrid').innerHTML = '<div class="error">Error al cargar estad√≠sticas</div>';
  }
}

async function handleQuizSelectChange(e) {
  const quizId = e.target.value;
  const leaderboardDiv = document.getElementById('leaderboard');
  const responsesCard = document.getElementById('responsesCard');
  
  if (!quizId) {
    leaderboardDiv.innerHTML = '<div class="loading">Selecciona un quiz para ver el ranking</div>';
    responsesCard.style.display = 'none';
    return;
  }
  
  leaderboardDiv.innerHTML = '<div class="loading">Cargando ranking...</div>';
  responsesCard.style.display = 'block';
  document.getElementById('responsesTable').innerHTML = '<div class="loading">Cargando respuestas...</div>';
  
  try {
    await loadLeaderboard(quizId);
    await loadResponsesTable(quizId);
  } catch (error) {
    console.error('Error loading data:', error);
    leaderboardDiv.innerHTML = '<div class="error">Error al cargar el ranking</div>';
    document.getElementById('responsesTable').innerHTML = '<div class="error">Error al cargar respuestas</div>';
  }
}

async function loadLeaderboard(quizId) {
  try {
    // Usar endpoint existente de participaciones generales y filtrar
    const response = await fetch(`${API_BASE_URL}/api/participations/?completed_only=true`);
    
    if (!response.ok) {
      throw new Error('Error al obtener participaciones');
    }
    
    const allParticipations = await response.json();
    
    // Obtener informaci√≥n del quiz seleccionado
    const quizResponse = await fetch(`${API_BASE_URL}/api/quizzes/${quizId}`);
    const selectedQuiz = await quizResponse.json();
    
    // Filtrar participaciones por el quiz seleccionado
    const participations = allParticipations.filter(p => p.quiz_title === selectedQuiz.title);
    
    if (participations.length === 0) {
      document.getElementById('leaderboard').innerHTML = `
        <div class="empty-leaderboard">
          <div class="icon">üèÜ</div>
          <h4>No hay participaciones a√∫n</h4>
          <p>Este quiz a√∫n no ha sido contestado por ning√∫n usuario.</p>
        </div>
      `;
      return;
    }
    
    // Ordenar por porcentaje y luego por score
    const rankings = participations.sort((a, b) => {
      if (b.percentage !== a.percentage) {
        return b.percentage - a.percentage;
      }
      return b.score - a.score;
    });
    
    // Generar HTML del leaderboard
    const leaderboardHtml = rankings.map((participant, index) => {
      const rank = index + 1;
      const rankClass = rank <= 3 ? `rank-${rank}` : '';
      const totalScore = Math.round(participant.percentage * 10); // Score basado en porcentaje
      
      return `
        <div class="leaderboard-item ${rankClass}">
          <div class="rank-info">
            <div class="rank-number">#${rank}</div>
            <div class="participant-info">
              <div class="participant-name">${participant.user_name}</div>
              <div class="participant-uni">${participant.user_uni}</div>
            </div>
          </div>
          <div class="score-info">
            <div class="total-score">${totalScore}</div>
            <div class="score-details">
              ${participant.score}/${participant.total_questions} correctas
              <br>
              ${participant.percentage.toFixed(1)}% precisi√≥n
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    document.getElementById('leaderboard').innerHTML = leaderboardHtml;
    
  } catch (error) {
    console.error('Error in loadLeaderboard:', error);
    document.getElementById('leaderboard').innerHTML = `
      <div class="error">
        Error al cargar el ranking: ${error.message}
      </div>
    `;
  }
}

// Reemplaza tu loadResponsesTable por esta versi√≥n.
// Usa el endpoint /api/quizzes/{quiz_id}/responses si est√° disponible (m√°s eficiente).
// Si no existe, intenta por participaciones: /api/participations/?completed_only=true&quiz_id=...
async function loadResponsesTable(quizId) {
  try {
    document.getElementById('responsesTable').innerHTML = `
      <div class="loading">Cargando respuestas...</div>
    `;

    // Usar el endpoint corregido
    const responsesResp = await fetch(`${API_BASE_URL}/api/quizzes/${quizId}/responses`);

    if (!responsesResp.ok) {
      throw new Error(`Error ${responsesResp.status}: ${responsesResp.statusText}`);
    }

    let responses = await responsesResp.json();
    console.log('Respuestas recibidas:', responses);

    // Verificar que sea un array
    if (!Array.isArray(responses)) {
      console.error('Respuesta no es un array:', responses);
      responses = [];
    }

    // Guardar globalmente
    window.currentResponsesData = responses;

    if (!responses.length) {
      document.getElementById('responsesTable').innerHTML = `
        <div class="responses-table">
          <table class="table table-striped table-compact">
            <thead>
              <tr>
                <th>Usuario</th><th>UNI</th><th>Pregunta #</th><th>Tipo</th><th>Pregunta</th>
                <th>Respuesta</th><th>Correcta</th><th>Tiempo (ms)</th><th>Fecha</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="9" class="empty-table">No hay respuestas registradas</td></tr>
            </tbody>
          </table>
        </div>
      `;
      return;
    }

    // Ordenar respuestas
    responses.sort((a, b) => {
      if (a.user_uni !== b.user_uni) return String(a.user_uni).localeCompare(String(b.user_uni));
      return (a.question_order || 0) - (b.question_order || 0);
    });

    // Renderizar tabla
    renderResponsesTable(responses);

  } catch (error) {
    console.error('Error loading responses table:', error);
    document.getElementById('responsesTable').innerHTML = `
      <div class="error">Error al cargar respuestas: ${error.message}</div>
    `;
  }
}

// Actualizar tambi√©n la funci√≥n renderResponsesTable
function renderResponsesTable(responses) {
  const tableRows = responses.map(response => {
    const correctClass = response.is_correct ? 'correct-answer' : 'incorrect-answer';
    const correctIcon = response.is_correct ? '‚úì' : '‚úó';
    const timeDisplay = `${response.response_time || 0}ms`;
    const dateDisplay = response.completed_at ? formatDate(response.completed_at) : '‚Äî';
    const questionType = response.question_type || 'multiple_choice';

    // Escapar y limpiar valores
    const user_name = escapeHtml(response.user_name || 'Usuario');
    const user_uni = escapeHtml(response.user_uni || 'N/A');
    const q_text = escapeHtml(response.question_text || 'Pregunta');
    const a_text = escapeHtml(response.answer_text || 'N/A');

    return `
      <tr>
        <td>${user_name}</td>
        <td><strong>${user_uni}</strong></td>
        <td>${response.question_order || 0}</td>
        <td>${questionType}</td>
        <td style="max-width: 300px; word-wrap: break-word;">${q_text}</td>
        <td style="max-width: 200px; word-wrap: break-word;">${a_text}</td>
        <td class="${correctClass}">${correctIcon} ${response.is_correct ? 'S√≠' : 'No'}</td>
        <td class="response-time">${timeDisplay}</td>
        <td>${dateDisplay}</td>
      </tr>
    `;
  }).join('');

  document.getElementById('responsesTable').innerHTML = `
    <div class="responses-table">
      <table class="table table-striped table-compact">
        <thead>
          <tr>
            <th>Usuario</th><th>UNI</th><th>Pregunta #</th><th>Tipo</th><th>Pregunta</th>
            <th>Respuesta</th><th>Correcta</th><th>Tiempo (ms)</th><th>Fecha</th>
          </tr>
        </thead>
        <tbody>${tableRows}</tbody>
      </table>
    </div>
  `;
}
// Peque√±as utilidades
function formatDate(dateStr) {
  try {
    const d = new Date(dateStr);
    // Formato local en espa√±ol (M√©xico), ajusta si quieres otro locale
    return d.toLocaleString('es-MX');
  } catch (e) {
    return dateStr;
  }
}

function escapeHtml(text) {
  if (text === null || text === undefined) return '';
  return String(text)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}


function exportResponses() {
  if (currentResponsesData.length === 0) {
    alert('No hay datos para exportar');
    return;
  }
  
  const quizSelect = document.getElementById('quizSelect');
  const selectedQuizText = quizSelect.options[quizSelect.selectedIndex].text;
  
  const csvData = currentResponsesData.map(response => ({
    'Usuario': response.user_name,
    'UNI': response.user_uni,
    'Pregunta #': response.question_order,
    'Pregunta': response.question_text,
    'Respuesta Seleccionada': response.answer_text,
    'Es Correcta': response.is_correct ? 'S√≠' : 'No',
    'Tiempo Respuesta (ms)': response.response_time,
    'Fecha Completado': new Date(response.completed_at).toLocaleString()
  }));
  
  const csv = convertToCSV(csvData);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', `respuestas_${selectedQuizText.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showSuccess('Archivo CSV descargado exitosamente');
}

function convertToCSV(data) {
  if (data.length === 0) return '';
  
  const headers = Object.keys(data[0]);
  const csvRows = [
    headers.join(','),
    ...data.map(row => 
      headers.map(header => {
        const value = row[header];
        const stringValue = String(value).replace(/"/g, '""');
        return stringValue.includes(',') || stringValue.includes('\n') || stringValue.includes('"') 
          ? `"${stringValue}"` 
          : stringValue;
      }).join(',')
    )
  ];
  
  return csvRows.join('\n');
}

async function loadQuizzes() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/quizzes/`);
    const quizzes = await response.json();
    
    const html = `
      <table class="table">
        <thead>
          <tr><th>T√≠tulo</th><th>√Årea</th><th>Estado</th><th>Creado</th><th>Acciones</th></tr>
        </thead>
        <tbody>
          ${quizzes.map(quiz => `
            <tr>
              <td><strong>${quiz.title}</strong></td>
              <td>${quiz.area}</td>
              <td>
                <span class="status-badge ${quiz.is_active ? 'status-active' : 'status-inactive'}">
                  ${quiz.is_active ? 'Activo' : 'Inactivo'}
                </span>
              </td>
              <td>${new Date(quiz.created_at).toLocaleDateString()}</td>
              <td>
                <button class="btn btn-small btn-primary" onclick="editQuiz(${quiz.id})">Editar</button>
                <button class="btn btn-small btn-warning" onclick="toggleQuizStatus(${quiz.id}, ${!quiz.is_active})">
                  ${quiz.is_active ? 'Desactivar' : 'Activar'}
                </button>
                <button class="btn btn-small btn-success" onclick="manageQuestions(${quiz.id}, '${quiz.title}')">Preguntas</button>
                <button class="btn btn-small btn-danger" onclick="deleteQuiz(${quiz.id})">Eliminar</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    
    document.getElementById('quizzesList').innerHTML = html;
    
  } catch (error) {
    console.error('Error loading quizzes:', error);
    document.getElementById('quizzesList').innerHTML = '<div class="error">Error al cargar quizzes</div>';
  }
}

async function loadUsers() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/users/`);
    const users = await response.json();

    if (users.length === 0) {
      document.getElementById('usersList').innerHTML = '<p>No hay usuarios registrados</p>';
      return;
    }

    const html = `
      <table class="table">
        <thead>
          <tr><th>UNI</th><th>Nombre</th><th>Fecha Registro</th><th>Acciones</th></tr>
        </thead>
        <tbody>
          ${users.map(user => `
            <tr>
              <td>${user.uni}</td>
              <td>${user.name}</td>
              <td>${new Date(user.created_at).toLocaleDateString()}</td>
              <td>
                <button class="btn btn-small btn-primary" onclick="editUser(${user.id})">Editar</button>
                <button class="btn btn-small btn-danger" onclick="deleteUser(${user.id})">Eliminar</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;

    document.getElementById('usersList').innerHTML = html;

  } catch (error) {
    console.error('Error loading users:', error);
    document.getElementById('usersList').innerHTML = '<div class="error">Error al cargar usuarios</div>';
  }
}

async function editUser(userId) {
  try {
    const response = await fetch(`${API_BASE_URL}/api/users/`);
    const users = await response.json();
    const user = users.find(u => u.id === userId);
    
    if (user) {
      openUserModal(user);
    } else {
      throw new Error('Usuario no encontrado');
    }
  } catch (error) {
    console.error('Error loading user:', error);
    alert('Error al cargar usuario');
  }
}

async function deleteUser(userId) {
  if (!confirm('¬øEst√°s seguro de eliminar este usuario?')) return;
  
  try {
    const res = await fetch(`${API_BASE_URL}/api/users/${userId}`, { method: 'DELETE' });
    if (res.ok) {
      showSuccess('Usuario eliminado exitosamente');
      loadUsers();
    } else {
      throw new Error('Error al eliminar usuario');
    }
  } catch (error) {
    console.error(error);
    alert('No se pudo eliminar el usuario');
  }
}

// Quiz Management Functions
function openQuizModal(quiz = null) {
  const modal = document.getElementById('quizModal');
  const title = document.getElementById('quizModalTitle');
  const form = document.getElementById('quizForm');
  
  if (quiz) {
    title.textContent = 'Editar Quiz';
    document.getElementById('quizId').value = quiz.id;
    document.getElementById('quizTitle').value = quiz.title;
    document.getElementById('quizArea').value = quiz.area;
    document.getElementById('quizDescription').value = quiz.description || '';
    document.getElementById('quizActive').checked = quiz.is_active;
  } else {
    title.textContent = 'Agregar Quiz';
    form.reset();
    document.getElementById('quizId').value = '';
    document.getElementById('quizActive').checked = false;
  }
  
  modal.classList.add('show');
}

async function editQuiz(quizId) {
  try {
    const response = await fetch(`${API_BASE_URL}/api/quizzes/${quizId}`);
    const quiz = await response.json();
    openQuizModal(quiz);
  } catch (error) {
    console.error('Error loading quiz:', error);
    alert('Error al cargar el quiz');
  }
}

async function handleQuizSubmit(e) {
  e.preventDefault();
  
  const quizId = document.getElementById('quizId').value;
  const quizData = {
    title: document.getElementById('quizTitle').value,
    area: document.getElementById('quizArea').value,
    description: document.getElementById('quizDescription').value,
    is_active: document.getElementById('quizActive').checked
  };
  
  try {
    let response;
    if (quizId) {
      response = await fetch(`${API_BASE_URL}/api/quizzes/${quizId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(quizData)
      });
    } else {
      response = await fetch(`${API_BASE_URL}/api/quizzes/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(quizData)
      });
    }
    
    if (response.ok) {
      closeModal('quizModal');
      loadQuizzes();
      showSuccess(quizId ? 'Quiz actualizado exitosamente' : 'Quiz creado exitosamente');
    } else {
      throw new Error('Error en la respuesta del servidor');
    }
    
  } catch (error) {
    console.error('Error saving quiz:', error);
    alert('Error al guardar el quiz');
  }
}

async function toggleQuizStatus(quizId, newStatus) {
  try {
    const response = await fetch(`${API_BASE_URL}/api/quizzes/${quizId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ is_active: newStatus })
    });
    
    if (response.ok) {
      loadQuizzes();
      showSuccess(`Quiz ${newStatus ? 'activado' : 'desactivado'} exitosamente`);
    } else {
      throw new Error('Error en la respuesta del servidor');
    }
    
  } catch (error) {
    console.error('Error toggling quiz status:', error);
    alert('Error al cambiar el estado del quiz');
  }
}

async function deleteQuiz(quizId) {
  if (confirm('¬øEst√°s seguro de que deseas eliminar este quiz?')) {
    try {
      const response = await fetch(`${API_BASE_URL}/api/quizzes/${quizId}`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        loadQuizzes();
        showSuccess('Quiz eliminado exitosamente');
      } else {
        throw new Error('Error en la respuesta del servidor');
      }
      
    } catch (error) {
      console.error('Error deleting quiz:', error);
      alert('Error al eliminar el quiz');
    }
  }
}

// User Management Functions
function openUserModal(user = null) {
  const modal = document.getElementById('userModal');
  const title = document.getElementById('userModalTitle');
  const form = document.getElementById('userForm');
  
  if (user) {
    title.textContent = 'Editar Usuario';
    document.getElementById('userId').value = user.id;
    document.getElementById('userUni').value = user.uni;
    document.getElementById('userName').value = user.name;
  } else {
    title.textContent = 'Agregar Usuario';
    form.reset();
    document.getElementById('userId').value = '';
  }
  
  modal.classList.add('show');
}

async function handleUserSubmit(e) {
  e.preventDefault();
  
  const userId = document.getElementById('userId').value;
  const userData = {
    uni: document.getElementById('userUni').value,
    name: document.getElementById('userName').value
  };
  
  try {
    let response;
    if (userId) {
      response = await fetch(`${API_BASE_URL}/api/users/${userId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      });
    } else {
      response = await fetch(`${API_BASE_URL}/api/users/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      });
    }
    
    if (response.ok) {
      closeModal('userModal');
      loadUsers();
      showSuccess(userId ? 'Usuario actualizado exitosamente' : 'Usuario creado exitosamente');
    } else {
      throw new Error('Error en la respuesta del servidor');
    }
    
  } catch (error) {
    console.error('Error saving user:', error);
    alert('Error al guardar el usuario');
  }
}

// Question Management Functions
async function manageQuestions(quizId, quizTitle) {
  currentQuizId = quizId;
  const modal = document.getElementById('questionsModal');
  const title = document.getElementById('questionsModalTitle');
  
  title.textContent = `Preguntas: ${quizTitle}`;
  modal.classList.add('show');
  
  await loadQuestions();
}

async function loadQuestions() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/quizzes/${currentQuizId}`);
    const quiz = await response.json();
    
    const questionsHtml = quiz.questions.map(question => `
      <div class="question-item">
        <div class="question-header">
          <div class="question-text">${question.question_order}. ${question.question_text}</div>
          <div class="question-actions">
            <button class="btn btn-small btn-primary" onclick="editQuestion(${question.id})">Editar</button>
            <button class="btn btn-small btn-danger" onclick="deleteQuestion(${question.id})">Eliminar</button>
          </div>
        </div>
        <div class="answer-list">
          ${question.answers.map(answer => `
            <div class="answer-item ${answer.is_correct ? 'answer-correct' : ''}">
              ${answer.answer_order}. ${answer.answer_text} ${answer.is_correct ? '‚úì' : ''}
            </div>
          `).join('')}
        </div>
        <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
          Tiempo l√≠mite: ${question.time_limit}s
        </div>
      </div>
    `).join('');
    
    document.getElementById('questionsList').innerHTML = questionsHtml || '<p>No hay preguntas en este quiz</p>';
    
  } catch (error) {
    console.error('Error loading questions:', error);
    document.getElementById('questionsList').innerHTML = '<div class="error">Error al cargar preguntas</div>';
  }
}

async function editQuestion(questionId) {
  try {
    const response = await fetch(`${API_BASE_URL}/api/questions/${questionId}`);
    const question = await response.json();
    openQuestionModal(question);
  } catch (error) {
    console.error('Error loading question:', error);
    alert('Error al cargar pregunta');
  }
}

async function deleteQuestion(questionId) {
  if (!confirm('¬øEliminar esta pregunta?')) return;
  
  try {
    const res = await fetch(`${API_BASE_URL}/api/questions/${questionId}`, { method: 'DELETE' });
    if (res.ok) {
      showSuccess('Pregunta eliminada');
      loadQuestions();
    } else {
      throw new Error('Error al eliminar pregunta');
    }
  } catch (error) {
    console.error(error);
    alert('No se pudo eliminar la pregunta');
  }
}

function openQuestionModal(question = null) {
  const modal = document.getElementById('questionModal');
  const title = document.getElementById('questionModalTitle');
  const form = document.getElementById('questionForm');
  
  document.getElementById('questionQuizId').value = currentQuizId;
  
  // Reset answer count
  answerCount = 0;
  
  if (question) {
    title.textContent = 'Editar Pregunta';
    document.getElementById('questionId').value = question.id;
    document.getElementById('questionText').value = question.question_text;
    document.getElementById('questionOrder').value = question.question_order;
    document.getElementById('questionTimeLimit').value = question.time_limit;
    
    // Load existing answers
    const container = document.getElementById('answersContainer');
    container.innerHTML = '';
    
    question.answers.forEach((answer, index) => {
      addAnswerField(answer.answer_text, answer.is_correct);
    });
  } else {
    title.textContent = 'Agregar Pregunta';
    form.reset();
    document.getElementById('questionId').value = '';
    document.getElementById('questionQuizId').value = currentQuizId;
    
    // Reset answers and add 4 default fields
    const container = document.getElementById('answersContainer');
    container.innerHTML = '';
    
    for (let i = 0; i < 4; i++) {
      addAnswerField();
    }
  }
  
  modal.classList.add('show');
}
//de aquii ------------------------------------------------------------------------------------------------------------------------------------
function removeAnswerField(button) {
  const questionType = document.getElementById('questionType').value;
  const answerTexts = document.querySelectorAll('.answer-text');
  
  // Para preguntas abiertas, no permitir eliminar la referencia
  if (questionType === 'open_ended') {
    alert('Las preguntas abiertas deben tener una respuesta de referencia');
    return;
  }
  
  // Para otros tipos, mantener al menos 2 respuestas
  if (answerTexts.length > 2) {
    button.parentElement.remove();
  } else {
    alert('Debe haber al menos 2 respuestas');
  }
}
// Agregar event listener para cambio de tipo
document.getElementById('questionType').addEventListener('change', handleQuestionTypeChange);

function handleQuestionTypeChange() {
  const questionType = document.getElementById('questionType').value;
  const imageGroup = document.getElementById('questionImageGroup');
  const answersContainer = document.getElementById('answersContainer');
  
  // Mostrar/ocultar campo de imagen
  if (questionType === 'image_choice') {
    imageGroup.style.display = 'block';
  } else {
    imageGroup.style.display = 'none';
  }
  
  // Limpiar respuestas y recrear seg√∫n tipo
  answersContainer.innerHTML = '';
  answerCount = 0;
  
  if (questionType === 'open_ended') {
    // Para preguntas abiertas, agregar un campo de referencia
    addAnswerField('Respuesta de referencia (opcional)', false, true);
    document.querySelector('input[name="correctAnswer"]').style.display = 'none';
  } else {
    // Para otros tipos, comportamiento normal
    for (let i = 0; i < 4; i++) {
      addAnswerField();
    }
  }
}

// Modificar funci√≥n addAnswerField
function addAnswerField(text = '', isCorrect = false, isReference = false) {
  answerCount++;
  const container = document.getElementById('answersContainer');
  const questionType = document.getElementById('questionType').value;
  
  const answerDiv = document.createElement('div');
  answerDiv.className = 'form-group';
  answerDiv.style.display = 'flex';
  answerDiv.style.gap = '12px';
  answerDiv.style.alignItems = 'center';
  answerDiv.dataset.answerIndex = answerCount;
  
  let inputField = '';
  if (questionType === 'image_choice') {
    inputField = `
      <input type="file" class="form-input answer-image" accept="image/*">
      <input type="text" class="form-input answer-text" placeholder="Descripci√≥n (opcional)" value="${text}">
    `;
  } else {
    inputField = `<input type="text" class="form-input answer-text" placeholder="Respuesta ${answerCount}" value="${text}" required>`;
  }
  
  const correctRadio = isReference ? '' : `
    <label style="display: flex; align-items: center; gap: 4px; white-space: nowrap;">
      <input type="radio" name="correctAnswer" value="${answerCount}" ${isCorrect ? 'checked' : ''}>
      Correcta
    </label>
  `;
  
  const removeButton = isReference ? '' : `
    <button type="button" class="btn btn-danger btn-small" onclick="removeAnswerField(this)">√ó</button>
  `;
  
  answerDiv.innerHTML = inputField + correctRadio + removeButton;
  container.appendChild(answerDiv);
}

// Funci√≥n para subir imagen
async function uploadImage(fileInput) {
  const file = fileInput.files[0];
  if (!file) return null;
  
  const formData = new FormData();
  formData.append('file', file);
  
  try {
    const response = await fetch(`${API_BASE_URL}/api/upload-image`, {
      method: 'POST',
      body: formData
    });
    
    // LOG para debugging
    console.log('Upload response status:', response.status);
    
    if (response.ok) {
      const data = await response.json();
      console.log('Upload response data:', data);
      return data.image_url;
    } else {
      // Intentar leer el mensaje de error del servidor
      const errorData = await response.json().catch(() => ({}));
      console.error('Server error:', errorData);
      throw new Error(errorData.detail || 'Error al subir imagen');
    }
  } catch (error) {
    console.error('Error uploading image:', error);
    alert(`Error al subir imagen: ${error.message}`);
    return null;
  }
}

// Modificar handleQuestionSubmit
async function handleQuestionSubmit(e) {
  e.preventDefault();
  
  const questionId = document.getElementById('questionId').value;
  const questionType = document.getElementById('questionType').value;
  
  // Subir imagen de pregunta si existe
  let questionImageUrl = null;
  const questionImageFile = document.getElementById('questionImageFile');
  if (questionImageFile && questionImageFile.files[0]) {
    questionImageUrl = await uploadImage(questionImageFile);
  }
  
  // Procesar respuestas seg√∫n tipo
  const answers = [];
  const answerDivs = document.querySelectorAll('[data-answer-index]');
  
  for (let i = 0; i < answerDivs.length; i++) {
    const div = answerDivs[i];
    const answerIndex = parseInt(div.dataset.answerIndex);
    
    let answerText = null;
    let imageUrl = null;
    let isCorrect = false;
    
    if (questionType === 'image_choice') {
      const imageInput = div.querySelector('.answer-image');
      const textInput = div.querySelector('.answer-text');
      
      if (imageInput && imageInput.files[0]) {
        imageUrl = await uploadImage(imageInput);
      }
      answerText = textInput ? textInput.value : null;
      
      const correctRadio = div.querySelector(`input[name="correctAnswer"][value="${answerIndex}"]`);
      isCorrect = correctRadio ? correctRadio.checked : false;
    } else {
      const textInput = div.querySelector('.answer-text');
      answerText = textInput ? textInput.value : null;
      
      if (questionType !== 'open_ended') {
        const correctRadio = div.querySelector(`input[name="correctAnswer"][value="${answerIndex}"]`);
        isCorrect = correctRadio ? correctRadio.checked : false;
      }
    }
    
    answers.push({
      answer_text: answerText,
      image_url: imageUrl,
      is_correct: isCorrect,
      answer_order: i + 1
    });
  }
  
  // Validaciones
  if (questionType !== 'open_ended') {
    const hasCorrect = answers.some(a => a.is_correct);
    if (!hasCorrect) {
      alert('Debe marcar al menos una respuesta como correcta');
      return;
    }
  }
  
  const questionData = {
    question_text: document.getElementById('questionText').value,
    question_type: questionType,
    image_url: questionImageUrl,
    question_order: parseInt(document.getElementById('questionOrder').value),
    time_limit: parseInt(document.getElementById('questionTimeLimit').value),
    answers: answers
  };
  
  // Enviar datos (resto igual que antes)
  try {
    let response;
    if (questionId) {
      response = await fetch(`${API_BASE_URL}/api/questions/${questionId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(questionData)
      });
    } else {
      response = await fetch(`${API_BASE_URL}/api/quizzes/${currentQuizId}/questions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(questionData)
      });
    }
    
    if (response.ok) {
      closeModal('questionModal');
      loadQuestions();
      showSuccess(questionId ? 'Pregunta actualizada exitosamente' : 'Pregunta creada exitosamente');
    } else {
      throw new Error('Error en la respuesta del servidor');
    }
    
  } catch (error) {
    console.error('Error saving question:', error);
    alert('Error al guardar la pregunta');
  }
}




//de aquii ------------------------------------------------------------------------------------------------------------------------------------
// Utility Functions
function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('show');
}

function showSuccess(message) {
  const successDiv = document.createElement('div');
  successDiv.className = 'success';
  successDiv.textContent = message;
  successDiv.style.position = 'fixed';
  successDiv.style.top = '20px';
  successDiv.style.right = '20px';
  successDiv.style.zIndex = '9999';
  successDiv.style.maxWidth = '300px';
  
  document.body.appendChild(successDiv);
  
  setTimeout(() => {
    if (document.body.contains(successDiv)) {
      document.body.removeChild(successDiv);
    }
  }, 3000);
}

// Close modals when clicking outside
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.remove('show');
    }
  });
});
  </script>
</body>
</html>